<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8">
  <title>BoniBuddy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#F6FBFE">
  <link rel="manifest" href="/static/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg: #F6FBFE;
      --card: #ffffff;
      --card2: #ffffff;
      --text: #111111;
      --muted: #5F6F7A;
      --disabled: #9ca3af;
      --border: rgba(0,166,246,0.18);
      --accent: #00A6F6;
      --accent-light: #92DBF3;
      --danger: #ef4444;
      --radius: 18px;
      --shadow: 0 12px 32px rgba(0,166,246,0.10);
    }

    * { box-sizing: border-box; }

    html, body{
      height: 100%;
      min-height: 100dvh;
      overflow: hidden;
    }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .card{
      width: 100%;
      max-width: 420px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 22px 20px calc(24px + env(safe-area-inset-bottom));
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      max-height: calc(100dvh - 48px - env(safe-area-inset-bottom));
      max-height: calc(100svh - 48px - env(safe-area-inset-bottom));
      min-height: 0;
      overflow: hidden;
      position: relative;
    }

    h1{
      font-size: 22px;
      margin: 0 0 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-align: center;
    }

    .logo-placeholder{
      flex: 0 0 auto;
      width: 92px;
      height: 92px;
      aspect-ratio: 1 / 1;
      border-radius: 50%;
      background: #EAF7FD;
      overflow: hidden;
      margin: 0 auto 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent);
    }

    .logo-placeholder svg{ 
      width: 100%;
      height: 100%;
      display: block;
    }

    .subtitle{
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 18px;
    }

    label{
      font-size: 13px;
      color: var(--muted);
      display: block;
      margin-bottom: 6px;
    }

    .ig-icon{
      width: 16px;
      height: 16px;
      fill: currentColor;
      opacity: 0.85;
      flex-shrink: 0;
    }

    .ig-label{
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .ig-label .ig-icon{
      width: 16px;
      height: 16px;
      fill: currentColor;
      opacity: 0.9;
    }

    select, input[type="text"]{
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      outline: none;
      font-size: 15px;
    }

    select:focus, input:focus{
      border-color: var(--accent);
      background: color-mix(in srgb, var(--accent-light) 20%, #ffffff 80%);
      box-shadow: 0 0 0 3px rgba(0,166,246,0.18);
    }

    /* Ensure native dropdown options stay readable on desktop browsers */
    @media (pointer: fine) {
      select option{
        color: #111111;
        background: #ffffff;
      }
    }

    .field{ margin-bottom: 14px; }

    .consent{
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 13px;
      color: var(--muted);
      margin: 12px 0 18px;
    }

    .consent input{ margin-top: 3px; }

    .btn{
      width: 100%;
      padding: 14px 16px;
      border-radius: 14px;
      border: 1px solid var(--accent);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      background: var(--accent);
      color: #ffffff;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .btn:active{ transform: scale(0.98); }

    .error{
      background: rgba(239,68,68,0.12);
      border: 1px solid rgba(239,68,68,0.35);
      color: #991b1b;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      margin-bottom: 14px;
    }

    .foot{
      margin-top: 18px;
      font-size: 11px;
      color: var(--muted);
      text-align: center;
    }

    .foot a{
      color: var(--muted);
      text-decoration: none;
      font-weight: 600;
    }

    .foot a:hover{
      color: var(--text);
      text-decoration: underline;
    }

    .ig-link{
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    /* Waiting board home */
    .home-header{flex:0 0 auto; display:flex; flex-direction:column; align-items:center; gap:6px;}
    .home-scroll{flex:1 1 auto; min-height:0; overflow-y:auto; -webkit-overflow-scrolling:touch; padding-right:2px;}
    .chip{height:44px; padding:0 16px; border-radius:14px; border:1.5px solid #92DBF3; background: transparent; color:#007FBF; text-decoration:none; font-weight:600; display:inline-flex; align-items:center; justify-content:center; flex:0 0 auto; white-space:nowrap; box-shadow: none;}
    .chip--active{border: none; background: var(--accent); color:#ffffff; box-shadow: none;}
    .time-row{display:flex; gap:10px; align-items:center; margin:6px 0 4px;}
    .time-input{width:100%; padding:12px 12px; border-radius:12px; border:1px solid rgba(0,166,246,0.18); background:#ffffff; color:var(--text); font-size:15px;}
    .time-input:focus{border-color: var(--accent); background: color-mix(in srgb, var(--accent-light) 20%, #ffffff 80%); box-shadow: 0 0 0 3px rgba(0,166,246,0.18);}
    .time-caption{font-size:12px; color:#8A9AA6; font-weight:400; margin-top:2px;}
    .muted{color: var(--muted);}
    .slot-form{display:flex; flex-direction:column; gap:10px; margin-top:8px;}
    .field-title{margin-top:6px; margin-bottom:2px; color:#111111; font-weight:700; font-size:14px;}
    .picker-wrap{position:relative;}
    .picker-input{width:100%; padding:12px 12px; border-radius:12px; border:1px solid rgba(0,166,246,0.18); background:#ffffff; color:var(--text); font-size:15px;}
    .picker-input:focus{border-color: var(--accent); background: color-mix(in srgb, var(--accent-light) 20%, #ffffff 80%); box-shadow: 0 0 0 3px rgba(0,166,246,0.18);}
    .suggestions{margin-top:8px; border:1px solid rgba(0,166,246,0.18); border-radius:12px; background:#ffffff; max-height:220px; overflow-y:auto; box-shadow:0 12px 24px rgba(0,166,246,0.10);}
    .suggestion-btn{width:100%; text-align:left; border:0; border-bottom:1px solid rgba(0,166,246,0.12); background:#ffffff; padding:10px 12px; cursor:pointer;}
    .suggestion-btn:last-child{border-bottom:none;}
    .suggestion-btn:hover{background:#EAF7FD;}
    .suggestion-name{font-size:14px; font-weight:600;}
    .suggestion-sub{font-size:12px; color:var(--muted); margin-top:2px;}
    .selected-card{margin-top:8px; border:1px solid rgba(0,166,246,0.20); border-radius:14px; padding:12px; background:#EAF7FD; display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .selected-card[hidden]{display:none !important;}
    .publish-status[hidden], .suggestions[hidden], .hint[hidden]{display:none !important;}
    .selected-name{font-size:15px; font-weight:700;}
    .selected-sub{font-size:12px; color:var(--muted); margin-top:2px;}
    .change-btn{border:1px solid rgba(0,166,246,0.35); background:#ffffff; color:#007FBF; border-radius:10px; padding:8px 10px; font-size:12px; font-weight:700; cursor:pointer; white-space:nowrap;}
    .change-btn:hover{background:#dff3fd;}
    .ig-input-wrap{position:relative;}
    input.ig-input{width:100%; padding:12px 12px 12px 44px; border-radius:12px; border:1px solid rgba(0,166,246,0.18); background:#ffffff; color:var(--text); font-size:15px;}
    input.ig-input:focus{border-color: var(--accent); background: color-mix(in srgb, var(--accent-light) 20%, #ffffff 80%); box-shadow: 0 0 0 3px rgba(0,166,246,0.18);}
    .ig-input-wrap .ig-icon{position:absolute; left:14px; top:50%; transform:translateY(-50%); pointer-events:none;}
    .hint{font-size:12px; color:var(--muted);}
    .hint--error{color:#991b1b;}
    .publish-status{border:1px solid rgba(0,166,246,0.22); background:#EAF7FD; color:#065f86; padding:10px 12px; border-radius:12px; font-size:13px;}
    .publish-status--error{border-color: rgba(239,68,68,0.35); background: rgba(239,68,68,0.12); color:#991b1b;}
    .btn[disabled]{background:#9FCBDE; border-color:#9FCBDE; color:#ffffff; cursor:not-allowed;}
    .live-feed-icon{position:absolute; top:14px; right:14px; display:inline-flex; justify-content:center; align-items:center; width:40px; height:40px; border-radius:50%; border:1.25px solid var(--accent); background: rgba(0,166,246,0.08); color: var(--accent); text-decoration:none; box-shadow:none; transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;}
    .live-feed-icon:hover, .live-feed-icon:focus{background: var(--accent); color:#ffffff; box-shadow: 0 8px 18px rgba(0,166,246,0.25); outline:none;}
    .live-feed-icon:active{transform: scale(0.97); background:#008ed5; color:#ffffff;}
    .live-feed-icon svg{width:18px; height:18px; display:block; fill:currentColor;}
    @media (max-width: 480px){
      .live-feed-icon{width:36px; height:36px; top:12px; right:12px;}
      .logo-placeholder{width:84px; height:84px;}
    }
  </style>
  {% include "_ga.html" %}
</head>
<body>
  <div class="card">
    {% if feature_waiting_board %}
      <a class="live-feed-icon" href="/feed" aria-label="Live feed" title="Live feed">
        <svg viewBox="0 0 256 256" aria-hidden="true" focusable="false">
          <rect width="256" height="256" fill="none"/>
          <path d="M96,192a32,32,0,0,0,64,0" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"/>
          <path d="M56,104a72,72,0,0,1,144,0c0,35.82,8.3,64.6,14.9,76A8,8,0,0,1,208,192H48a8,8,0,0,1-6.88-12C47.71,168.6,56,139.81,56,104Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"/>
        </svg>
      </a>
      <div class="home-header">
        <div class="logo-placeholder" aria-hidden="true">
          <svg viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
            <g clip-path="url(#clip0_187_175)">
              <rect width="512" height="512" fill="#F5F5F5"/>
              <path d="M408 126C516.248 126 604 230.542 604 359.5C604 488.458 516.248 593 408 593H104C-4.24781 593 -92 488.458 -92 359.5C-92 230.542 -4.24781 126 104 126C165.318 126 220.06 159.545 256 212.071C291.94 159.545 346.682 126 408 126Z" fill="url(#paint0_radial_187_175)"/>
              <mask id="mask0_187_175" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="113" y="261" width="101" height="81">
                <path d="M163.812 261.566C191.434 261.566 213.826 283.959 213.826 311.581C213.826 322.912 210.056 333.361 203.705 341.747C191.756 336.784 177.561 333.907 162.333 333.907C148.064 333.907 134.701 336.432 123.243 340.834C117.301 332.608 113.797 322.504 113.797 311.581C113.797 283.959 136.189 261.567 163.812 261.566Z" fill="white"/>
              </mask>
              <g mask="url(#mask0_187_175)">
                <circle cx="163.796" cy="311.581" r="50.0147" fill="white"/>
                <path d="M130.503 292.783C135.206 284.638 142.766 278.53 151.716 275.643C160.667 272.756 170.371 273.297 178.946 277.16C187.521 281.023 194.356 287.933 198.125 296.549C201.894 305.166 202.328 314.876 199.343 323.794C196.359 332.713 190.168 340.206 181.972 344.819C173.777 349.432 164.16 350.836 154.987 348.76C145.814 346.684 137.739 341.275 132.328 333.583C126.917 325.89 124.556 316.462 125.703 307.128L163.362 311.754L130.503 292.783Z" fill="#131313"/>
              </g>
              <mask id="mask1_187_175" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="296" y="261" width="101" height="81">
                <path d="M346.827 261.566C374.45 261.566 396.842 283.959 396.842 311.581C396.842 322.912 393.072 333.361 386.721 341.747C374.772 336.784 360.577 333.907 345.349 333.907C331.079 333.907 317.716 336.432 306.259 340.834C300.317 332.608 296.813 322.504 296.812 311.581C296.812 283.959 319.205 261.566 346.827 261.566Z" fill="white"/>
              </mask>
              <g mask="url(#mask1_187_175)">
                <circle cx="346.812" cy="311.581" r="50.0147" fill="white"/>
                <path d="M313.519 292.783C318.221 284.638 325.781 278.53 334.732 275.643C343.683 272.756 353.387 273.297 361.962 277.16C370.537 281.023 377.372 287.933 381.14 296.549C384.909 305.166 385.343 314.876 382.359 323.794C379.374 332.713 373.184 340.206 364.988 344.819C356.792 349.432 347.175 350.836 338.002 348.76C328.829 346.684 320.755 341.275 315.344 333.583C309.933 325.89 307.572 316.462 308.719 307.128L346.378 311.754L313.519 292.783Z" fill="#131313"/>
              </g>
              <path d="M185.508 378.436C185.508 378.436 228.062 399.355 256.928 398.834C285.794 398.313 324.638 378.436 324.638 378.436" stroke="#25130D" stroke-width="11.1304" stroke-linecap="round"/>
            </g>
            <defs>
              <radialGradient id="paint0_radial_187_175" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(256 359.5) rotate(90) scale(233.5 348)">
                <stop stop-color="#00A6F6"/>
                <stop offset="1" stop-color="#92DBF3"/>
              </radialGradient>
              <clipPath id="clip0_187_175">
                <rect width="512" height="512" fill="white"/>
              </clipPath>
            </defs>
          </svg>
        </div>
        <h1 style="margin-bottom:6px;">Greš na bone?</h1>
      </div>
      <div class="home-scroll">
        {% include "_active_plan.html" %}
        {% if msg %}<div class="error" style="margin-top:4px;">{{ msg }}</div>{% endif %}

        <form id="publishForm" class="slot-form" novalidate>
          <input type="hidden" id="selectedRestaurantId" name="restaurant_id" value="{{ selected_restaurant_id }}">
          <input type="hidden" id="refInput" name="ref" value="{{ ref }}">

          <div class="field-title">Kdaj greš</div>
          <div class="time-row">
            <input id="goTimeInput" class="time-input" type="time" name="go_time" value="{{ selected_go_time }}" step="300" required>
          </div>
          <div class="time-caption">Aktivno okno: <span id="windowLabel">{{ selected_window_label }}</span></div>

          <div class="field-title">Poišči kam greš</div>
          <div id="restaurantInputWrap" class="picker-wrap">
            <input id="restSearchInput" class="picker-input" type="text" placeholder="Vpiši ime restavracije" autocomplete="off">
          </div>
          <div id="restaurantSuggestions" class="suggestions" hidden></div>
          <div id="restaurantNoResults" class="hint" hidden>Ni zadetkov.</div>

          <div id="selectedRestaurantCard" class="selected-card" hidden>
            <div>
              <div id="selectedRestaurantName" class="selected-name"></div>
              <div id="selectedRestaurantSub" class="selected-sub"></div>
            </div>
            <button id="changeRestaurantBtn" type="button" class="change-btn">Spremeni</button>
          </div>

          <div class="field-title">Instagram</div>
          <div class="ig-input-wrap">
            <svg class="ig-icon" aria-hidden="true" viewBox="0 0 24 24">
              <path d="M7 2C4.2 2 2 4.2 2 7v10c0 2.8 2.2 5 5 5h10c2.8 0 5-2.2 5-5V7c0-2.8-2.2-5-5-5H7zm0 2h10c1.7 0 3 1.3 3 3v10c0 1.7-1.3 3-3 3H7c-1.7 0-3-1.3-3-3V7c0-1.7 1.3-3 3-3zm11.5 1a1.5 1.5 0 100 3 1.5 1.5 0 000-3zM12 7a5 5 0 100 10 5 5 0 000-10zm0 2a3 3 0 110 6 3 3 0 010-6z"/>
            </svg>
            <input id="userIdInput" class="ig-input" type="text" name="user_id" placeholder="tvoj Instagram" value="{{ user_id }}" required>
          </div>
          <div id="igHint" class="hint">Dovoljeni znaki: črke, številke, pika in podčrtaj.</div>
          <button id="publishBtn" class="btn" type="submit" disabled>Potrdi</button>
          <div id="publishStatus" class="publish-status" hidden></div>
        </form>
      </div>
    {% else %}
      <div class="logo-placeholder" aria-hidden="true">
        <svg viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
          <g clip-path="url(#clip0_187_175)">
            <rect width="512" height="512" fill="#F5F5F5"/>
            <path d="M408 126C516.248 126 604 230.542 604 359.5C604 488.458 516.248 593 408 593H104C-4.24781 593 -92 488.458 -92 359.5C-92 230.542 -4.24781 126 104 126C165.318 126 220.06 159.545 256 212.071C291.94 159.545 346.682 126 408 126Z" fill="url(#paint0_radial_187_175)"/>
            <mask id="mask0_187_175" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="113" y="261" width="101" height="81">
              <path d="M163.812 261.566C191.434 261.566 213.826 283.959 213.826 311.581C213.826 322.912 210.056 333.361 203.705 341.747C191.756 336.784 177.561 333.907 162.333 333.907C148.064 333.907 134.701 336.432 123.243 340.834C117.301 332.608 113.797 322.504 113.797 311.581C113.797 283.959 136.189 261.567 163.812 261.566Z" fill="white"/>
            </mask>
            <g mask="url(#mask0_187_175)">
              <circle cx="163.796" cy="311.581" r="50.0147" fill="white"/>
              <path d="M130.503 292.783C135.206 284.638 142.766 278.53 151.716 275.643C160.667 272.756 170.371 273.297 178.946 277.16C187.521 281.023 194.356 287.933 198.125 296.549C201.894 305.166 202.328 314.876 199.343 323.794C196.359 332.713 190.168 340.206 181.972 344.819C173.777 349.432 164.16 350.836 154.987 348.76C145.814 346.684 137.739 341.275 132.328 333.583C126.917 325.89 124.556 316.462 125.703 307.128L163.362 311.754L130.503 292.783Z" fill="#131313"/>
            </g>
            <mask id="mask1_187_175" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="296" y="261" width="101" height="81">
              <path d="M346.827 261.566C374.45 261.566 396.842 283.959 396.842 311.581C396.842 322.912 393.072 333.361 386.721 341.747C374.772 336.784 360.577 333.907 345.349 333.907C331.079 333.907 317.716 336.432 306.259 340.834C300.317 332.608 296.813 322.504 296.812 311.581C296.812 283.959 319.205 261.566 346.827 261.566Z" fill="white"/>
            </mask>
            <g mask="url(#mask1_187_175)">
              <circle cx="346.812" cy="311.581" r="50.0147" fill="white"/>
              <path d="M313.519 292.783C318.221 284.638 325.781 278.53 334.732 275.643C343.683 272.756 353.387 273.297 361.962 277.16C370.537 281.023 377.372 287.933 381.14 296.549C384.909 305.166 385.343 314.876 382.359 323.794C379.374 332.713 373.184 340.206 364.988 344.819C356.792 349.432 347.175 350.836 338.002 348.76C328.829 346.684 320.755 341.275 315.344 333.583C309.933 325.89 307.572 316.462 308.719 307.128L346.378 311.754L313.519 292.783Z" fill="#131313"/>
            </g>
            <path d="M185.508 378.436C185.508 378.436 228.062 399.355 256.928 398.834C285.794 398.313 324.638 378.436 324.638 378.436" stroke="#25130D" stroke-width="11.1304" stroke-linecap="round"/>
          </g>
          <defs>
            <radialGradient id="paint0_radial_187_175" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(256 359.5) rotate(90) scale(233.5 348)">
              <stop stop-color="#00A6F6"/>
              <stop offset="1" stop-color="#92DBF3"/>
            </radialGradient>
            <clipPath id="clip0_187_175">
              <rect width="512" height="512" fill="white"/>
            </clipPath>
          </defs>
        </svg>
      </div>
      <h1 style="margin-bottom:6px;">Greš na bone</h1>
      <a class="chip chip--active" href="/">Nazaj na začetek</a>
    {% endif %}
  </div>
<script>
  // Service worker (best-effort)
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/static/sw.js').catch(() => {
        // best-effort; do nothing if SW registration fails
      });
    });
  }

  // Waiting-board live filter
  {% if feature_waiting_board %}
  (function() {
    const restaurants = {{ restaurants | tojson }};
    const INSTAGRAM_RE = /^[A-Za-z0-9._]{1,30}$/;
    const DEFAULT_HINT = 'Dovoljeni znaki: črke, številke, pika in podčrtaj.';
    const LOCKED_UID = {{ (locked_uid or "") | tojson }};
    const LOCKED_HINT = LOCKED_UID ? `Brskalnik je trenutno vezan na @${LOCKED_UID}.` : '';

    const form = document.getElementById('publishForm');
    const goTimeInput = document.getElementById('goTimeInput');
    const windowLabel = document.getElementById('windowLabel');
    const selectedRestaurantIdInput = document.getElementById('selectedRestaurantId');
    const searchInput = document.getElementById('restSearchInput');
    const suggestions = document.getElementById('restaurantSuggestions');
    const noResults = document.getElementById('restaurantNoResults');
    const inputWrap = document.getElementById('restaurantInputWrap');
    const selectedCard = document.getElementById('selectedRestaurantCard');
    const selectedName = document.getElementById('selectedRestaurantName');
    const selectedSub = document.getElementById('selectedRestaurantSub');
    const changeBtn = document.getElementById('changeRestaurantBtn');
    const userIdInput = document.getElementById('userIdInput');
    const publishBtn = document.getElementById('publishBtn');
    const publishStatus = document.getElementById('publishStatus');
    const refInput = document.getElementById('refInput');
    const igHint = document.getElementById('igHint');
    if (!form || !goTimeInput || !windowLabel || !selectedRestaurantIdInput || !searchInput || !suggestions || !selectedCard || !selectedName || !selectedSub || !changeBtn || !userIdInput || !publishBtn || !publishStatus || !refInput || !igHint || !inputWrap || !noResults) return;

    let selectedRestaurant = restaurants.find(item => item.id === selectedRestaurantIdInput.value) || null;
    let isSubmitting = false;
    let searchEventSent = false;

    function normalizeInstagram(value) {
      return (value || '').trim().replace(/^@+/, '');
    }

    function isValidInstagram(value) {
      const normalized = normalizeInstagram(value);
      return INSTAGRAM_RE.test(normalized);
    }

    function windowLabelFrom(goTime) {
      if (!goTime || !goTime.includes(':')) return '';
      const parts = goTime.split(':');
      const hh = Number(parts[0]);
      const mm = Number(parts[1]);
      if (Number.isNaN(hh) || Number.isNaN(mm)) return '';
      const startMins = hh * 60 + mm;
      const endMins = (startMins + 30) % (24 * 60);
      const start = `${String(Math.floor(startMins / 60)).padStart(2, '0')}:${String(startMins % 60).padStart(2, '0')}`;
      const end = `${String(Math.floor(endMins / 60)).padStart(2, '0')}:${String(endMins % 60).padStart(2, '0')}`;
      return `${start}\u2013${end}`;
    }

    function setStatus(message, isError) {
      if (!message) {
        publishStatus.hidden = true;
        publishStatus.textContent = '';
        publishStatus.classList.remove('publish-status--error');
        return;
      }
      publishStatus.hidden = false;
      publishStatus.textContent = message;
      publishStatus.classList.toggle('publish-status--error', !!isError);
    }

    function updateIgHint() {
      const value = userIdInput.value.trim();
      const normalized = normalizeInstagram(value);
      if (!value) {
        igHint.textContent = LOCKED_HINT || DEFAULT_HINT;
        igHint.classList.remove('hint--error');
        return;
      }
      if (!isValidInstagram(value)) {
        igHint.textContent = 'Vpiši veljavno Instagram uporabniško ime.';
        igHint.classList.add('hint--error');
        return;
      }
      if (LOCKED_UID && normalized.toLowerCase() !== LOCKED_UID.toLowerCase()) {
        igHint.textContent = `${LOCKED_HINT} Za zamenjavo najprej prekliči trenutni plan.`;
        igHint.classList.add('hint--error');
        return;
      }
      igHint.textContent = LOCKED_HINT || DEFAULT_HINT;
      igHint.classList.remove('hint--error');
    }

    function updateButtonState() {
      const hasTime = !!(goTimeInput.value || '').trim();
      const hasRestaurant = !!(selectedRestaurant && selectedRestaurant.id);
      const hasValidIg = isValidInstagram(userIdInput.value);
      publishBtn.disabled = isSubmitting || !hasTime || !hasRestaurant || !hasValidIg;
      if (!isSubmitting) {
        publishBtn.textContent = 'Potrdi';
      }
    }

    function renderSelectedCard() {
      if (!selectedRestaurant) {
        selectedCard.hidden = true;
        inputWrap.hidden = false;
        selectedRestaurantIdInput.value = '';
        updateButtonState();
        return;
      }
      selectedName.textContent = selectedRestaurant.name || '';
      selectedSub.textContent = selectedRestaurant.subtitle || '';
      selectedCard.hidden = false;
      inputWrap.hidden = true;
      selectedRestaurantIdInput.value = selectedRestaurant.id;
      suggestions.hidden = true;
      noResults.hidden = true;
      updateButtonState();
    }

    function renderSuggestions() {
      if (selectedRestaurant) {
        suggestions.hidden = true;
        noResults.hidden = true;
        return;
      }
      const q = (searchInput.value || '').trim().toLowerCase();
      suggestions.innerHTML = '';
      if (!q) {
        suggestions.hidden = true;
        noResults.hidden = true;
        return;
      }
      const filtered = restaurants
        .filter(item => {
          const name = (item.name || '').toLowerCase();
          const sub = (item.subtitle || '').toLowerCase();
          return name.includes(q) || sub.includes(q);
        })
        .sort((a, b) => {
          const aPrefix = (a.name || '').toLowerCase().startsWith(q) ? 0 : 1;
          const bPrefix = (b.name || '').toLowerCase().startsWith(q) ? 0 : 1;
          if (aPrefix !== bPrefix) return aPrefix - bPrefix;
          return (a.name || '').localeCompare((b.name || ''), 'sl');
        })
        .slice(0, 8);

      if (filtered.length === 0) {
        suggestions.hidden = true;
        noResults.hidden = false;
        return;
      }

      filtered.forEach(item => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'suggestion-btn';
        btn.dataset.id = item.id;
        const nameEl = document.createElement('div');
        nameEl.className = 'suggestion-name';
        nameEl.textContent = item.name || '';
        const subEl = document.createElement('div');
        subEl.className = 'suggestion-sub';
        subEl.textContent = item.subtitle || '';
        btn.appendChild(nameEl);
        btn.appendChild(subEl);
        btn.addEventListener('click', () => {
          selectedRestaurant = item;
          searchInput.value = '';
          renderSelectedCard();
          syncUrlState();
        });
        suggestions.appendChild(btn);
      });
      noResults.hidden = true;
      suggestions.hidden = false;
    }

    function syncUrlState() {
      try {
        const url = new URL(window.location.href);
        const timeValue = (goTimeInput.value || '').trim();
        if (timeValue) url.searchParams.set('go_time', timeValue);
        else url.searchParams.delete('go_time');
        if (selectedRestaurant && selectedRestaurant.id) url.searchParams.set('restaurant_id', selectedRestaurant.id);
        else url.searchParams.delete('restaurant_id');
        const refValue = (refInput.value || '').trim();
        if (refValue) url.searchParams.set('ref', refValue);
        else url.searchParams.delete('ref');
        window.history.replaceState({}, '', url.toString());
      } catch (e) {}
    }

    goTimeInput.addEventListener('change', () => {
      windowLabel.textContent = windowLabelFrom(goTimeInput.value) || windowLabel.textContent;
      syncUrlState();
      updateButtonState();
    });

    searchInput.addEventListener('focus', renderSuggestions);
    searchInput.addEventListener('input', () => {
      if (!searchEventSent) {
        const len = (searchInput.value || '').trim().length;
        if (len > 0) {
          searchEventSent = true;
          if (typeof window.gtag === 'function') {
            gtag('event', 'search_used', { query_length: len });
          }
        }
      }
      renderSuggestions();
    });
    searchInput.addEventListener('blur', () => {
      setTimeout(() => {
        if (!selectedRestaurant) suggestions.hidden = true;
      }, 120);
    });

    changeBtn.addEventListener('click', () => {
      selectedRestaurant = null;
      setStatus('', false);
      renderSelectedCard();
      searchInput.value = '';
      searchInput.focus();
      syncUrlState();
      renderSuggestions();
    });

    userIdInput.addEventListener('input', () => {
      updateIgHint();
      updateButtonState();
    });
    userIdInput.addEventListener('blur', () => {
      userIdInput.value = normalizeInstagram(userIdInput.value);
      updateIgHint();
      updateButtonState();
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (isSubmitting) return;
      const normalizedUser = normalizeInstagram(userIdInput.value);
      userIdInput.value = normalizedUser;
      updateIgHint();
      updateButtonState();
      if (publishBtn.disabled || !selectedRestaurant) return;

      isSubmitting = true;
      publishBtn.textContent = 'Objavljam...';
      updateButtonState();
      setStatus('', false);

      try {
        const res = await fetch('/api/waiting/publish', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            restaurant_id: selectedRestaurant.id,
            go_time: goTimeInput.value,
            user_id: normalizedUser,
            ref: (refInput.value || '').trim() || null,
          }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok) {
          const lockedMismatch = data.error === 'locked_browser_uid_mismatch';
          setStatus((lockedMismatch && data.message) ? data.message : (data.message || 'Objava ni uspela.'), true);
          return;
        }

        if (typeof window.gtag === 'function') {
          gtag('event', 'slot_filled', {
            restaurant_id: selectedRestaurant.id,
            go_time: goTimeInput.value,
          });
        }
        userIdInput.value = data.user_id || normalizedUser;
        if (data.window_label) windowLabel.textContent = data.window_label;
        renderSelectedCard();
        setStatus(data.message || 'Plan objavljen.', false);
        syncUrlState();
      } catch (e) {
        setStatus('Prišlo je do napake. Poskusi znova.', true);
      } finally {
        isSubmitting = false;
        updateButtonState();
      }
    });

    if (!windowLabel.textContent.trim()) {
      const label = windowLabelFrom(goTimeInput.value);
      if (label) windowLabel.textContent = label;
    }
    renderSelectedCard();
    if (!selectedRestaurant) {
      suggestions.hidden = true;
      noResults.hidden = true;
    }
    updateIgHint();
    updateButtonState();
    syncUrlState();
  })();
{% endif %}
</script>
</body>
</html>
