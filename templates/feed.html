<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8">
  <title>BoniBuddy • Feed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg: #F6FBFE;
      --card: #ffffff;
      --text: #111111;
      --muted: #5F6F7A;
      --border: rgba(0,166,246,0.18);
      --accent: #00A6F6;
      --radius: 18px;
      --shadow: 0 12px 32px rgba(0,166,246,0.10);
    }
    * { box-sizing: border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      background: var(--bg);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .card{
      width: 100%;
      max-width: 520px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 22px 20px 24px;
      backdrop-filter: blur(10px);
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    h1{margin:0; font-size:20px; font-weight:800; text-align:left;}
    .muted{color: var(--muted); font-size:13px;}
    .list{display:flex; flex-direction:column; gap:10px;}
    .rest-row{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-radius:14px; border:1px solid rgba(0,166,246,0.18); background:#F6FCFF; color: var(--text); text-decoration:none; box-shadow: 0 6px 16px rgba(0,166,246,0.06);}
    .rest-row--active{background:#E6F4FE; border-color: var(--accent); box-shadow: 0 6px 16px rgba(0,166,246,0.10);}
    .rest-info{flex:1; min-width:0;}
    .top-row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      width:100%;
    }
    .rest-name{
      font-size:15px;
      font-weight:600;
      min-width:0;
      flex:1;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .rest-time{
      font-size:15px;
      font-weight:600;
      color:var(--text);
      white-space:nowrap;
      flex-shrink:0;
      text-align:right;
    }
    .bottom-row{
      display:flex;
      justify-content:flex-start;
      margin-top:8px;
      width:100%;
    }
    .rest-user-pill{
      display:inline-flex;
      align-items:center;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid #05A5F7;
      background:#05A5F7;
      color:#FFFFFF;
      font-size:14px;
      font-weight:800;
      line-height:1.1;
      white-space:nowrap;
      max-width:70%;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .status{font-size:12px; color: var(--muted);} 
    .error{background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.35); color: #991b1b; padding: 10px 12px; border-radius: 12px; font-size: 13px;}
  </style>
  {% include "_ga.html" %}
</head>
<body>
  <div class="card" style="position:relative;">
    <h1>Kdo gre kam?</h1>
    {% if msg %}<div class="error">{{ msg }}</div>{% endif %}
    <div id="status" class="status"></div>
    <div id="list" class="list"></div>
    <div id="empty" class="muted" style="display:none;">Trenutno ni aktivnih kartic.</div>
    <a href="/" class="muted" style="font-size:12px; text-decoration:none;">↩ Nazaj</a>
  </div>

<script>
  const INITIAL_ITEMS = {{ items | tojson }};

  const listEl = document.getElementById('list');
  const emptyEl = document.getElementById('empty');
  const statusEl = document.getElementById('status');

  function render(items) {
    listEl.innerHTML = '';
    const safeItems = items || [];
    if (safeItems.length === 0) {
      emptyEl.style.display = '';
      return;
    }
    emptyEl.style.display = 'none';
    safeItems.forEach(item => {
      const a = document.createElement('a');
      a.className = 'rest-row rest-row--active';
      a.href = `/waiting/${encodeURIComponent(item.restaurant_id)}/quick-join?go_time=${encodeURIComponent(item.go_time)}`;

      const info = document.createElement('div');
      info.className = 'rest-info';
      const topEl = document.createElement('div');
      topEl.className = 'top-row';
      const nameEl = document.createElement('div');
      nameEl.className = 'rest-name';
      nameEl.textContent = item.restaurant_name || '';
      const timeEl = document.createElement('div');
      timeEl.className = 'rest-time';
      timeEl.textContent = item.window_label || '';
      topEl.appendChild(nameEl);
      topEl.appendChild(timeEl);
      info.appendChild(topEl);
      const members = Array.isArray(item.members) ? item.members : [];
      if (members.length) {
        const handles = members
          .map(m => `@${String(m || '').replace(/^@+/, '')}`)
          .filter(Boolean);
        if (handles.length) {
          const bottomEl = document.createElement('div');
          bottomEl.className = 'bottom-row';
          const handleEl = document.createElement('span');
          handleEl.className = 'rest-user-pill';
          handleEl.textContent = handles[0];
          bottomEl.appendChild(handleEl);
          info.appendChild(bottomEl);
        }
      }

      a.appendChild(info);
      listEl.appendChild(a);
    });
  }

  render(INITIAL_ITEMS);

  async function refreshFeed() {
    try {
      const res = await fetch('/api/feed');
      if (!res.ok) throw new Error('bad status');
      const data = await res.json();
      render(data.items || []);
      statusEl.textContent = '';
    } catch (e) {
      statusEl.textContent = 'Posodobitev ni uspela, poskusim znova…';
    }
  }

  setInterval(refreshFeed, 10000);
</script>
</body>
</html>
