<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8">
  <title>BoniBuddy • {{ 'Dogovorjeno' if join_intent else ('Zaključeno' if joined_existing else 'Plan objavljen') }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg: #F6FBFE;
      --card: #ffffff;
      --card2: #ffffff;
      --text: #111111;
      --muted: #5F6F7A;
      --disabled: #9ca3af;
      --border: rgba(0,166,246,0.18);
      --accent: #00A6F6;
      --accent-light: #92DBF3;
      --danger: #dc2626;
      --danger-border: rgba(220,38,38,0.32);
      --danger-bg: rgba(220,38,38,0.08);
      --radius: 18px;
      --shadow: 0 12px 32px rgba(0,166,246,0.10);
    }
    *{box-sizing:border-box;}
    html, body{
      height: 100%;
      min-height: 100dvh;
      overflow: hidden;
    }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      background: var(--bg);
    }
    .page{
      min-height: 100dvh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      padding-bottom: calc(24px + env(safe-area-inset-bottom));
    }
    .card{
      width:100%;
      max-width:460px;
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:18px 18px calc(20px + env(safe-area-inset-bottom));
      backdrop-filter: blur(10px);
      max-height: calc(100dvh - 48px - env(safe-area-inset-bottom));
      display:flex;
      flex-direction:column;
      overflow:hidden;
      min-height:0;
    }
    h1{margin:6px 0 4px; font-size:24px; line-height:1.15; text-align:center;}
    .logo-placeholder{
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: #EAF7FD;
      overflow: hidden;
      margin: 0 auto 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent);
    }
    .logo-placeholder svg{
      width: 100%;
      height: 100%;
      display: block;
    }
    .cta-stack{display:flex; flex-direction:column; gap:7px; align-items:center; margin-top:10px; width:100%; max-width:320px;}
    .btn{
      display:inline-flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      width:100%;
      min-width:200px;
      max-width:320px;
      padding:13px 16px;
      border-radius:14px;
      border:1px solid var(--accent);
      background: var(--accent);
      color:#ffffff;
      font-weight:700;
      text-decoration:none;
      transition: background 0.2s ease, transform 0.12s ease;
      box-shadow: 0 6px 16px rgba(0,166,246,0.12);
    }
    .btn:hover{background:#008ed5;}
    .btn svg{
      width:16px;
      height:16px;
      fill: currentColor;
      flex-shrink:0;
    }
    .btn-text{
      display:inline-block;
      max-width:220px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      vertical-align:bottom;
    }
    .link{display:inline-block; margin-top:16px; color:var(--accent); text-decoration:none; font-size:13px;}
    .link:hover{text-decoration:underline; color:#005f8f;}
    .footer-link{display:flex; justify-content:flex-start;}
    .actions-secondary{
      width:100%;
      max-width:320px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      margin-top:10px;
      font-size:13px;
    }
    .actions-secondary form{margin:0;}
    .action-link{
      border:0;
      background:transparent;
      padding:0;
      margin:0;
      color:var(--accent);
      font-size:13px;
      line-height:1.3;
      text-decoration:none;
      cursor:pointer;
      font-weight:500;
    }
    .action-link:hover{text-decoration:underline; color:#005f8f;}
    .action-link--danger{color:var(--danger);}
    .action-link--danger:hover{color:#b91c1c;}
    .card-body{display:flex; flex-direction:column; gap:10px; align-items:center; min-height:0;}
    .status-pill{
      border:1px solid rgba(0,166,246,0.28);
      background:#EAF7FD;
      color:#0470ad;
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
      font-weight:700;
      line-height:1;
    }
    .body-text{font-size:14px; color: var(--muted); text-align:center; line-height:1.45; margin:0 4px 4px;}
    .summary-card{
      width:100%;
      max-width:320px;
      border:1px solid rgba(0,166,246,0.20);
      background:#EAF7FD;
      border-radius:14px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      animation: summary-enter 220ms ease-out both;
    }
    .summary-row{display:flex; flex-direction:column; gap:2px; text-align:center;}
    .summary-label{font-size:12px; color:var(--muted);}
    .summary-value{font-size:22px; font-weight:700; line-height:1.1; color:var(--text);}
    .summary-value--handle{font-size:16px;}
    .summary-divider{height:1px; background:rgba(0,166,246,0.14);}
    .other-handles{width:100%; max-width:320px; font-size:12px; color:var(--muted); line-height:1.4; text-align:left; margin-top:2px;}
    .field-title{margin-top:2px; margin-bottom:0; color:#111111; font-weight:700; font-size:14px; width:100%; max-width:320px;}
    .ig-input-wrap{position:relative; width:100%; max-width:320px;}
    .ig-icon{position:absolute; left:14px; top:50%; transform:translateY(-50%); width:16px; height:16px; fill:currentColor; opacity:0.9; pointer-events:none;}
    .ig-input{width:100%; padding:12px 12px 12px 44px; border-radius:12px; border:1px solid rgba(0,166,246,0.18); background:#ffffff; color:var(--text); font-size:15px; outline:none;}
    .ig-input:focus{border-color: var(--accent); background: color-mix(in srgb, var(--accent-light) 20%, #ffffff 80%); box-shadow: 0 0 0 3px rgba(0,166,246,0.18);}
    .hint{width:100%; max-width:320px; font-size:12px; color:var(--muted);}
    .hint--error{color:#991b1b;}
    .status-box{width:100%; max-width:320px; border:1px solid rgba(0,166,246,0.22); background:#EAF7FD; color:#065f86; padding:10px 12px; border-radius:12px; font-size:13px;}
    .status-box--error{border-color: rgba(239,68,68,0.35); background: rgba(239,68,68,0.12); color:#991b1b;}
    .status-box[hidden]{display:none !important;}
    .btn[disabled]{background:#A7D7EC; border-color:#A7D7EC; color:#f8fcff; cursor:not-allowed; box-shadow:none; filter:saturate(0.85);}
    .btn:active{transform:scale(0.98);}
    @keyframes summary-enter{
      from {opacity:0; transform:translateY(6px);}
      to {opacity:1; transform:translateY(0);}
    }
    @media (max-width: 480px){
      .page{padding:16px; padding-bottom: calc(16px + env(safe-area-inset-bottom));}
      .card{padding:16px 16px calc(16px + env(safe-area-inset-bottom));}
      .summary-card{padding:10px;}
      .summary-value{font-size:20px;}
      .summary-value--handle{font-size:15px;}
      .btn{font-size:15px; padding:12px 14px;}
      .btn-text{max-width:190px;}
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <div class="card-body">
        <div class="logo-placeholder" aria-hidden="true">
          <svg viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
            <g clip-path="url(#clip0_187_175)">
              <rect width="512" height="512" fill="#F5F5F5"/>
              <path d="M408 126C516.248 126 604 230.542 604 359.5C604 488.458 516.248 593 408 593H104C-4.24781 593 -92 488.458 -92 359.5C-92 230.542 -4.24781 126 104 126C165.318 126 220.06 159.545 256 212.071C291.94 159.545 346.682 126 408 126Z" fill="url(#paint0_radial_187_175)"/>
              <mask id="mask0_187_175" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="113" y="261" width="101" height="81">
                <path d="M163.812 261.566C191.434 261.566 213.826 283.959 213.826 311.581C213.826 322.912 210.056 333.361 203.705 341.747C191.756 336.784 177.561 333.907 162.333 333.907C148.064 333.907 134.701 336.432 123.243 340.834C117.301 332.608 113.797 322.504 113.797 311.581C113.797 283.959 136.189 261.567 163.812 261.566Z" fill="white"/>
              </mask>
              <g mask="url(#mask0_187_175)">
                <circle cx="163.796" cy="311.581" r="50.0147" fill="white"/>
                <path d="M130.503 292.783C135.206 284.638 142.766 278.53 151.716 275.643C160.667 272.756 170.371 273.297 178.946 277.16C187.521 281.023 194.356 287.933 198.125 296.549C201.894 305.166 202.328 314.876 199.343 323.794C196.359 332.713 190.168 340.206 181.972 344.819C173.777 349.432 164.16 350.836 154.987 348.76C145.814 346.684 137.739 341.275 132.328 333.583C126.917 325.89 124.556 316.462 125.703 307.128L163.362 311.754L130.503 292.783Z" fill="#131313"/>
              </g>
              <mask id="mask1_187_175" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="296" y="261" width="101" height="81">
                <path d="M346.827 261.566C374.45 261.566 396.842 283.959 396.842 311.581C396.842 322.912 393.072 333.361 386.721 341.747C374.772 336.784 360.577 333.907 345.349 333.907C331.079 333.907 317.716 336.432 306.259 340.834C300.317 332.608 296.813 322.504 296.812 311.581C296.812 283.959 319.205 261.566 346.827 261.566Z" fill="white"/>
              </mask>
              <g mask="url(#mask1_187_175)">
                <circle cx="346.812" cy="311.581" r="50.0147" fill="white"/>
                <path d="M313.519 292.783C318.221 284.638 325.781 278.53 334.732 275.643C343.683 272.756 353.387 273.297 361.962 277.16C370.537 281.023 377.372 287.933 381.14 296.549C384.909 305.166 385.343 314.876 382.359 323.794C379.374 332.713 373.184 340.206 364.988 344.819C356.792 349.432 347.175 350.836 338.002 348.76C328.829 346.684 320.755 341.275 315.344 333.583C309.933 325.89 307.572 316.462 308.719 307.128L346.378 311.754L313.519 292.783Z" fill="#131313"/>
              </g>
              <path d="M185.508 378.436C185.508 378.436 228.062 399.355 256.928 398.834C285.794 398.313 324.638 378.436 324.638 378.436" stroke="#25130D" stroke-width="11.1304" stroke-linecap="round"/>
            </g>
            <defs>
              <radialGradient id="paint0_radial_187_175" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(256 359.5) rotate(90) scale(233.5 348)">
                <stop stop-color="#00A6F6"/>
                <stop offset="1" stop-color="#92DBF3"/>
              </radialGradient>
              <clipPath id="clip0_187_175">
                <rect width="512" height="512" fill="white"/>
              </clipPath>
            </defs>
          </svg>
        </div>
        {% if join_intent %}
          <h1>Dogovorjeno</h1>
          <div class="status-pill">Potrjeno</div>
          <div class="summary-card">
            <div class="summary-row">
              <div class="summary-label">Termin</div>
              <div class="summary-value">{{ window_label }}</div>
            </div>
            <div class="summary-divider"></div>
            <div class="summary-row">
              <div class="summary-label">Greš z</div>
              <div class="summary-value summary-value--handle">
                {% if primary_other %}
                  {{ primary_other }}{% if other_count > 0 %} +{{ other_count }}{% endif %}
                {% else %}
                  Zaenkrat brez kontakta
                {% endif %}
              </div>
            </div>
          </div>
          <div class="field-title">Tvoj Instagram</div>
          <div class="ig-input-wrap">
            <svg class="ig-icon" aria-hidden="true" viewBox="0 0 24 24">
              <path d="M7 2C4.2 2 2 4.2 2 7v10c0 2.8 2.2 5 5 5h10c2.8 0 5-2.2 5-5V7c0-2.8-2.2-5-5-5H7zm0 2h10c1.7 0 3 1.3 3 3v10c0 1.7-1.3 3-3 3H7c-1.7 0-3-1.3-3-3V7c0-1.7 1.3-3 3-3zm11.5 1a1.5 1.5 0 100 3 1.5 1.5 0 000-3zM12 7a5 5 0 100 10 5 5 0 000-10zm0 2a3 3 0 110 6 3 3 0 010-6z"/>
            </svg>
            <input id="joinUserInput" class="ig-input" type="text" autocomplete="off" placeholder="tvoj Instagram" value="{{ prefill_user_id or '' }}">
          </div>
          <div id="joinHint" class="hint"></div>
          <div id="joinStatus" class="status-box" hidden></div>
          <button
            class="btn"
            id="joinAndContactBtn"
            type="button"
            data-restaurant-id="{{ join_api_payload.restaurant_id }}"
            data-go-time="{{ join_api_payload.go_time }}"
            disabled
          >
            Pridruži se
          </button>
          <div class="actions-secondary">
            <a class="action-link" href="/feed">Nazaj na pregled</a>
          </div>
        {% elif joined_existing %}
          <h1>Dogovorjeno</h1>
          <div class="status-pill">Potrjeno</div>
          <div class="summary-card">
            <div class="summary-row">
              <div class="summary-label">Termin</div>
              <div class="summary-value">{{ window_label }}</div>
            </div>
            <div class="summary-divider"></div>
            <div class="summary-row">
              <div class="summary-label">Greš z</div>
              <div class="summary-value summary-value--handle">
                {% if primary_other %}
                  {{ primary_other }}{% if other_count > 0 %} +{{ other_count }}{% endif %}
                {% else %}
                  Zaenkrat brez kontakta
                {% endif %}
              </div>
            </div>
          </div>

          {% if others_instagram_links %}
            {% set primary_contact = others_instagram_links[0] %}
            <div class="cta-stack">
              <a class="btn" href="{{ primary_contact.url }}" target="_blank" rel="noopener">
                <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                  <path d="M7 2C4.2 2 2 4.2 2 7v10c0 2.8 2.2 5 5 5h10c2.8 0 5-2.2 5-5V7c0-2.8-2.2-5-5-5H7zm0 2h10c1.7 0 3 1.3 3 3v10c0 1.7-1.3 3-3 3H7c-1.7 0-3-1.3-3-3V7c0-1.7 1.3-3 3-3zm11.5 1a1.5 1.5 0 100 3 1.5 1.5 0 000-3zM12 7a5 5 0 100 10 5 5 0 000-10zm0 2a3 3 0 110 6 3 3 0 010-6z"/>
                </svg>
                <span class="btn-text">Kontaktiraj {{ primary_contact.handle }}</span>
              </a>
            </div>
            {% if others_instagram_links|length > 1 %}
              <div class="other-handles">Ostali: {% for other in others_instagram_links[1:] %}{{ other.handle }}{% if not loop.last %}, {% endif %}{% endfor %}</div>
            {% endif %}
          {% else %}
            <div class="body-text">Zaenkrat ni drugega uporabnika za kontakt.</div>
          {% endif %}
          <div class="actions-secondary">
            <form method="post" action="/waiting/leave">
              <input type="hidden" name="restaurant_id" value="{{ restaurant.id }}">
              <input type="hidden" name="user_id" value="{{ user_id }}">
              <input type="hidden" name="go_time" value="{{ go_time }}">
              <button class="action-link action-link--danger" type="submit">Prekliči plan</button>
            </form>
            <a class="action-link" href="/">Nazaj na pregled</a>
          </div>
        {% else %}
          <h1>Plan objavljen</h1>
          <div class="status-pill">Aktivno</div>
          <div class="summary-card">
            <div class="summary-row">
              <div class="summary-label">Termin</div>
              <div class="summary-value">{{ window_label }}</div>
            </div>
          </div>
          <div class="body-text">Drugi uporabniki ga lahko zdaj vidijo in se ti pridružijo.</div>

          <div class="cta-stack">
            <button class="btn" id="shareInviteBtn" type="button" data-url="{{ share_url }}" data-msg="{{ copy_invite_message }}">Deli povabilo</button>
          </div>
          <div class="actions-secondary">
            <form method="post" action="/waiting/leave">
              <input type="hidden" name="restaurant_id" value="{{ restaurant.id }}">
              <input type="hidden" name="user_id" value="{{ user_id }}">
              <input type="hidden" name="go_time" value="{{ go_time }}">
              <button class="action-link action-link--danger" type="submit">Prekliči plan</button>
            </form>
            <a class="action-link" href="/">Nazaj na pregled</a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  <script>
    (function(){
      const btn = document.getElementById('joinAndContactBtn');
      if(!btn) return;
      const userInput = document.getElementById('joinUserInput');
      const hintEl = document.getElementById('joinHint');
      const statusEl = document.getElementById('joinStatus');
      if(!userInput || !hintEl || !statusEl) return;

      const INSTAGRAM_RE = /^[A-Za-z0-9._]{1,30}$/;
      const lockedUid = {{ (locked_uid or "") | tojson }};
      const defaultHint = lockedUid
        ? `Brskalnik je trenutno vezan na @${lockedUid}.`
        : 'Vpiši svoj Instagram za pridružitev.';
      let isSubmitting = false;

      function normalizeInstagram(value){
        return (value || '').trim().replace(/^@+/, '');
      }

      function isValidInstagram(value){
        return INSTAGRAM_RE.test(normalizeInstagram(value));
      }

      function setHint(text, isError){
        hintEl.textContent = text || '';
        hintEl.classList.toggle('hint--error', !!isError);
      }

      function setStatus(text, isError){
        if(!text){
          statusEl.hidden = true;
          statusEl.textContent = '';
          statusEl.classList.remove('status-box--error');
          return;
        }
        statusEl.hidden = false;
        statusEl.textContent = text;
        statusEl.classList.toggle('status-box--error', !!isError);
      }

      function updateState(){
        const normalized = normalizeInstagram(userInput.value);
        const hasValidIg = isValidInstagram(normalized);

        if(!normalized){
          setHint(defaultHint, false);
        }else if(!hasValidIg){
          setHint('Vpiši veljavno Instagram uporabniško ime.', true);
        }else if(lockedUid && normalized.toLowerCase() !== lockedUid.toLowerCase()){
          setHint(`${defaultHint} Za zamenjavo najprej prekliči trenutni plan.`, true);
        }else{
          setHint(defaultHint, false);
        }

        btn.disabled = isSubmitting || !hasValidIg;
        if(!isSubmitting) btn.textContent = 'Pridruži se';
      }

      userInput.addEventListener('input', () => {
        setStatus('', false);
        updateState();
      });
      userInput.addEventListener('blur', () => {
        userInput.value = normalizeInstagram(userInput.value);
        updateState();
      });

      btn.addEventListener('click', async () => {
        const normalized = normalizeInstagram(userInput.value);
        userInput.value = normalized;
        setStatus('', false);
        updateState();
        if(btn.disabled) return;

        isSubmitting = true;
        btn.textContent = 'Pridružujem...';
        updateState();

        const restaurantId = (btn.dataset.restaurantId || '').trim();
        const goTime = (btn.dataset.goTime || '').trim();

        try{
          const res = await fetch('/api/waiting/publish', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              restaurant_id: restaurantId,
              go_time: goTime,
              user_id: normalized,
            }),
          });
          const data = await res.json().catch(() => ({}));
          if(!res.ok || !data.ok){
            setStatus(data.message || 'Pridružitev ni uspela.', true);
            return;
          }

          const doneUrl = new URL(`/done/${encodeURIComponent(restaurantId)}`, window.location.origin);
          doneUrl.searchParams.set('go_time', data.go_time || goTime);
          doneUrl.searchParams.set('u', data.user_id || normalized);
          doneUrl.searchParams.set('created', '0');
          window.location.assign(doneUrl.toString());
        }catch(_err){
          setStatus('Prišlo je do napake. Poskusi znova.', true);
        }finally{
          isSubmitting = false;
          updateState();
        }
      });

      updateState();
    })();

    (function(){
      const btn = document.getElementById('shareInviteBtn');
      if(!btn) return;
      const original = btn.textContent;
      const inviteText = btn.dataset.msg || '';
      const inviteUrl = btn.dataset.url || window.location.href;
      const fullUrl = inviteUrl.startsWith('http') ? inviteUrl : `${window.location.origin}${inviteUrl}`;

      async function shareNative(){
        if(!navigator.share) throw new Error('no_share');
        await navigator.share({
          title: 'Pridruži se na BoniBuddy',
          text: inviteText,
          url: fullUrl
        });
      }

      async function copyFallback(){
        await navigator.clipboard.writeText(`${inviteText}\n${fullUrl}`.trim());
      }

      btn.addEventListener('click', async () => {
        try { window.gtag && gtag('event', 'share_invite_click', { restaurant_id: '{{ restaurant.id }}', go_time: '{{ go_time }}' }); } catch(e) {}
        try{
          await shareNative();
          btn.textContent = 'Poslano ✅';
          try { window.gtag && gtag('event', 'share_invite_sent', { method: 'native', restaurant_id: '{{ restaurant.id }}', go_time: '{{ go_time }}' }); } catch(e) {}
        }catch(err){
          try{
            await copyFallback();
            btn.textContent = 'Povezava kopirana';
            try { window.gtag && gtag('event', 'share_invite_sent', { method: 'copy', restaurant_id: '{{ restaurant.id }}', go_time: '{{ go_time }}' }); } catch(e) {}
          }catch(_err){
            btn.textContent = 'Deljenje ni uspelo';
          }
        }
        setTimeout(() => { btn.textContent = original; }, 2200);
      });
    })();
  </script>
</body>
</html>
