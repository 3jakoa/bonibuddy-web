<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8">
  <title>BoniBuddy ‚Ä¢ ƒåakam</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root{
      --bg: #F6FBFE;
      --card: #ffffff;
      --card2: #ffffff;
      --text: #111111;
      --muted: #5F6F7A;
      --disabled: #9ca3af;
      --border: rgba(0,166,246,0.18);
      --accent: #00A6F6;
      --accent-light: #92DBF3;
      --danger: #ef4444;
      --radius: 18px;
      --shadow: 0 12px 32px rgba(0,166,246,0.10);
    }

    * { box-sizing: border-box; }

    html, body{
      height: 100%;
      min-height: 100dvh;
      overflow: hidden;
    }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      background: var(--bg);
    }

    .page{
      min-height: 100dvh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      padding-bottom: calc(24px + env(safe-area-inset-bottom));
    }

    .card{
      width: 100%;
      max-width: 440px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 22px 20px calc(24px + env(safe-area-inset-bottom));
      backdrop-filter: blur(10px);
      max-height: calc(100dvh - 48px - env(safe-area-inset-bottom));
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    .card-body{
      display: flex;
      flex-direction: column;
      gap: 0;
      min-height: 0;
    }

    h1{
      font-size: 20px;
      margin: 0 0 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .subtitle{
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 16px;
      line-height: 1.35;
    }

    .chips{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0 16px;
    }

    .chip{
      border: 1.5px solid #92DBF3;
      background: transparent;
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 13px;
      color: #007FBF;
      box-shadow: none;
    }

    .muted{ color: var(--muted); }

    .row{ margin-top: 14px; }

    .ig-icon{
      width: 16px;
      height: 16px;
      fill: currentColor;
      opacity: 0.85;
      flex-shrink: 0;
    }

    .btn{
      width: 100%;
      padding: 14px 16px;
      border-radius: 14px;
      border: 1px solid var(--accent);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      background: var(--accent);
      color: #ffffff;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      transition: background 0.2s ease;
      box-shadow: 0 6px 16px rgba(0,166,246,0.12);
    }
    .btn:hover{background:#008ed5;}

    .btn:active{ transform: scale(0.98); }

    .link{
      display: inline-block;
      margin-top: 14px;
      color: var(--accent);
      text-decoration: none;
      font-size: 13px;
    }
    .link:hover{ text-decoration: underline; color:#005f8f; }

    .spinner{
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid rgba(0,166,246,0.18);
      border-top-color: rgba(0,166,246,0.75);
      display: inline-block;
      vertical-align: -3px;
      margin-right: 8px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .error{
      background: rgba(239,68,68,0.12);
      border: 1px solid rgba(239,68,68,0.35);
      color: #991b1b;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      margin: 12px 0 4px;
    }

    .box{
      border: 1px solid var(--border);
      background: #ffffff;
      border-radius: 14px;
      padding: 12px;
      font-size: 13px;
      color: var(--text);
      line-height: 1.35;
    }

    .label{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .cta-row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    .cta-row button{flex:1; min-width:120px; padding:12px 10px; border-radius:12px; border:1px solid var(--accent); background: var(--accent); color:#ffffff; font-weight:700; cursor:pointer; transition: background 0.2s ease; box-shadow: 0 6px 16px rgba(0,166,246,0.12);}
    .cta-row button:hover{background:#008ed5;}
    .input-row{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; position:relative;}
    .input-row input{flex:1; min-width:200px; padding:12px 12px 12px 40px; border-radius:12px; border:1px solid rgba(0,166,246,0.18); background: #ffffff; color:var(--text); box-shadow: 0 0 0 0 rgba(0,166,246,0.10);}    
    .input-row .ig-icon{position:absolute; left:14px; top:50%; transform: translateY(-50%);}
    .status{font-size:13px; color:var(--muted); margin-top:8px;}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border-radius:12px; border:1px solid var(--border); background: #ffffff; font-size:12px;}
    .badge{padding:6px 9px; border-radius:10px; background: transparent; border:1px solid #05A5F7; font-weight:700; font-size:13px; color:#05A5F7;}
    .badge--active{background: #05A5F7; border-color: #05A5F7; color:#ffffff; box-shadow: 0 3px 10px rgba(5,165,247,0.22);}
    .time-picker-row{display:flex; gap:10px; margin:14px 0 8px;}
    .time-picker-row input[type="time"]{width:100%; padding:12px 12px; border-radius:12px; border:1px solid rgba(0,166,246,0.18); background:#ffffff; color:var(--text); font-size:15px;}
    .time-picker-row input[type="time"]:focus{border-color: var(--accent); background: color-mix(in srgb, var(--accent-light) 20%, #ffffff 80%); box-shadow: 0 0 0 3px rgba(0,166,246,0.18);}
    .window-card{border:1px solid rgba(0,166,246,0.18); background:#EAF7FD; border-radius:14px; padding:12px; margin:8px 0 14px;}
    .window-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; gap:12px;}
    .window-title{font-weight:700;}
    .window-members{font-size:13px; color:var(--muted);}
    .time-caption{font-size:12px; color:#8A9AA6; font-weight:400; margin:0;}
  </style>
  {% include "_ga.html" %}
</head>
<body>
  <div class="page">
    <div class="card">
      <div class="card-body">
        {% if feature_waiting_board %}
          {% include "_active_plan.html" %}
          <h1>üìç {{ restaurant.name }}</h1>
          {% if msg %}<div class="error" style="margin-top:0;">{{ msg }}</div>{% endif %}

          <form method="post" action="/waiting/join" id="joinForm" style="display:flex; flex-direction:column; gap:0; min-height:0;">
            <input type="hidden" name="restaurant_id" value="{{ restaurant_id }}">
            <input type="hidden" id="refInput" name="ref" value="{{ request.query_params.get('ref') or '' }}">

            <label class="label" for="goTimePicker" style="margin-top:12px;">Kdaj gre≈°</label>
            <div class="time-picker-row">
              <input type="time" id="goTimePicker" name="go_time" value="{{ selected_go_time }}" step="300" required>
            </div>
            <p class="time-caption">Aktivno okno: <span id="windowLabel">{{ selected_window_label }}</span></p>

            <div class="window-card">
              <div class="window-header">
                <span class="window-title">Kdo gre v tem ƒçasu</span>
                <span class="badge {% if selected_count > 0 %}badge--active{% endif %}" id="selectedCountBadge">
                  {% if selected_count == 1 %}1 gre{% elif selected_count == 0 %}0 gre{% else %}{{ selected_count }} gredo{% endif %}
                </span>
              </div>
              <div class="window-members" id="selectedMembers">
                {% if selected_members %}
                  {%- set handles = selected_members[:2] -%}
                  {%- set extra = selected_members|length - handles|length -%}
                  {%- for m in handles -%}
                    @{{ m }}{% if not loop.last %}, {% endif %}
                  {%- endfor -%}
                  {% if extra > 0 %} +{{ extra }}{% endif %}
                {% endif %}
              </div>
            </div>

            <div class="input-row">
              <svg class="ig-icon" aria-hidden="true" viewBox="0 0 24 24">
                <path d="M7 2C4.2 2 2 4.2 2 7v10c0 2.8 2.2 5 5 5h10c2.8 0 5-2.2 5-5V7c0-2.8-2.2-5-5-5H7zm0 2h10c1.7 0 3 1.3 3 3v10c0 1.7-1.3 3-3 3H7c-1.7 0-3-1.3-3-3V7c0-1.7 1.3-3 3-3zm11.5 1a1.5 1.5 0 100 3 1.5 1.5 0 000-3zM12 7a5 5 0 100 10 5 5 0 000-10zm0 2a3 3 0 110 6 3 3 0 010-6z"/>
              </svg>
              <input id="userIdInput" name="user_id" type="text" placeholder="tvoj Instagram" value="{{ user_id }}" required>
            </div>
            <div class="cta-row">
              <button type="submit">Potrdi</button>
            </div>
          </form>

          {% if user_go_time %}
            <div class="status">
              <span class="pill">Tvoj ƒças: {{ user_go_time }}</span>
            </div>
            <form method="post" action="/waiting/leave" style="margin-top:10px;">
              <input type="hidden" name="restaurant_id" value="{{ restaurant_id }}">
              <input type="hidden" name="user_id" value="{{ user_id }}">
              <input type="hidden" id="leaveGoTimeInput" name="go_time" value="{{ selected_go_time }}">
              <button class="btn" type="submit" style="width:100%; background:#ffffff; color: var(--accent); border:1px solid var(--accent);">Prekliƒçi</button>
            </form>
          {% endif %}
          <a class="link" href="/" style="display:inline-block; margin-top:16px;">Nazaj na lokacije</a>
          <script>
            (function() {
              const focus = {{ 'true' if join_focus else 'false' }};
              if (focus) {
                const el = document.getElementById('userIdInput');
                if (el) { setTimeout(() => el.focus(), 50); }
              }
              const picker = document.getElementById('goTimePicker');
              const leaveInput = document.getElementById('leaveGoTimeInput');
              if (picker) {
                if (leaveInput) leaveInput.value = picker.value;
                picker.addEventListener('change', () => {
                  if (leaveInput) leaveInput.value = picker.value;
                  try {
                    const url = new URL(window.location.href);
                    url.searchParams.set('go_time', picker.value);
                    window.history.replaceState({}, '', url.toString());
                  } catch (e) {}
                });
              }
            })();

            // Live refresh of counts/members for selected go_time
            (function() {
              const restaurantId = '{{ restaurant_id }}';
              const picker = document.getElementById('goTimePicker');
              const badgeEl = document.getElementById('selectedCountBadge');
              const membersEl = document.getElementById('selectedMembers');
              const labelEl = document.getElementById('windowLabel');
              if (!restaurantId || !picker || !badgeEl || !membersEl || !labelEl) return;

              function renderBadge(el, count) {
                if (!el) return;
                el.classList.toggle('badge--active', count > 0);
                if (count === 1) el.textContent = '1 gre';
                else if (count === 0) el.textContent = '0 gre';
                else el.textContent = `${count} gredo`;
              }

              function renderMembers(el, members) {
                if (!el) return;
                if (!members || !members.length) { el.textContent = ''; return; }
                const handles = members.slice(0, 2).map(m => `@${m}`);
                const extra = members.length - handles.length;
                el.textContent = handles.join(', ') + (extra > 0 ? ` +${extra}` : '');
              }

              async function refresh() {
                try {
                  const res = await fetch(`/api/waiting_board/${restaurantId}?go_time=${encodeURIComponent(picker.value)}`);
                  if (!res.ok) return;
                  const data = await res.json();
                  labelEl.textContent = data.window_label || '';
                  renderBadge(badgeEl, Number(data.count || 0));
                  renderMembers(membersEl, data.members || []);
                } catch (e) {
                  // best effort; ignore
                }
              }

              refresh();
              picker.addEventListener('change', refresh);
              setInterval(refresh, 5000);
            })();

            // GA: slot_filled ‚Äî fire once when join form is submitted
            (function() {
              const form = document.getElementById('joinForm');
              if (!form) return;
              let sent = false;
              form.addEventListener('submit', () => {
                if (sent || typeof window.gtag !== 'function') return;
                sent = true;
                const restaurantId = form.querySelector('input[name=\"restaurant_id\"]')?.value || undefined;
                const goTime = form.querySelector('input[name=\"go_time\"]')?.value || undefined;
                gtag('event', 'slot_filled', {
                  restaurant_id: restaurantId,
                  go_time: goTime,
                });
              });
            })();
          </script>
        {% else %}
          <h1 id="heading">ƒåakamo ≈°e na koga üëÄ</h1>
          <div class="subtitle">
            <span class="spinner" aria-hidden="true"></span>
            Osve≈æujem vsakih nekaj sekund. ƒåe je kdo online ob podobnem ƒçasu, te pove≈æem.
          </div>

          <div class="chips">
            <div class="chip">üìç <b>{{ location }}</b></div>
            <div class="chip">üïí <b>{% if time_bucket == "today" %}Za veƒçerjo üçï{% else %}Za kosilo üçù{% endif %}</b></div>
          </div>


          <div id="status" class="muted">≈†e ni matcha‚Ä¶</div>

          <div class="row" id="notifRow" style="display:none;">
            <button class="btn" id="enableNotifBtn" type="button">üîî Obvesti me, ko dobim match</button>
            <div id="notifHint" class="muted" style="margin-top:10px; font-size:13px;"></div>
          </div>

          <div class="row">
            <a class="link" href="/">Nazaj</a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

{% if not feature_waiting_board %}
<script>
  const RID = "{{ rid }}";
  window.VAPID_PUBLIC_KEY = "{{ vapid_public_key }}";

  const waitingStart = Date.now();
  let sentWaitingDuration = false;

  function sendWaitingDuration(reason) {
    if (sentWaitingDuration) return;
    sentWaitingDuration = true;
    const duration_seconds = Math.round((Date.now() - waitingStart) / 1000);
    if (typeof window.gtag === 'function') {
      gtag('event', 'waiting_duration', { duration_seconds, reason });
    }
  }

  if (typeof document !== 'undefined') {
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof window.gtag === 'function') {
        gtag('event', 'waiting_viewed');
      }
    });
  }

  window.addEventListener('pagehide', () => sendWaitingDuration('leave'));
  window.addEventListener('beforeunload', () => sendWaitingDuration('leave'));

  function isStandaloneApp() {
    return (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) ||
           (navigator.standalone === true);
  }

    function notificationsSupported() {
      return ('Notification' in window);
    }

    function pushSupported() {
      return ('serviceWorker' in navigator) && ('PushManager' in window);
    }

    function updateNotifUI() {
      const row = document.getElementById('notifRow');
      const hint = document.getElementById('notifHint');
      const btn = document.getElementById('enableNotifBtn');
      if (!row || !hint || !btn) return;

      if (!isStandaloneApp() || !notificationsSupported()) {
        row.style.display = 'none';
        return;
      }

      row.style.display = 'block';

      if (!pushSupported()) {
        btn.style.display = 'none';
        hint.textContent = 'Push obvestila niso podprta v tem brskalniku/na tej napravi.';
        return;
      }

      if (Notification.permission === 'granted') {
        btn.style.display = 'none';
        hint.textContent = 'Obvestila so vkljuƒçena ‚úÖ';
      } else if (Notification.permission === 'denied') {
        btn.style.display = 'none';
        hint.textContent = 'Obvestila so blokirana v nastavitvah brskalnika.';
      } else {
        btn.style.display = 'inline-block';
        hint.textContent = 'Klikni, da ti lahko po≈°ljem obvestilo, ko najdem match.';
      }
    }

    async function ensureServiceWorkerRegistered() {
      try {
        if (!('serviceWorker' in navigator)) return;
        await navigator.serviceWorker.register('/sw.js', { scope: '/' });
      } catch (e) {}
    }

    async function bestEffortSubscribePush() {
      try {
        await ensureServiceWorkerRegistered();
        if (!pushSupported() || Notification.permission !== 'granted') return;

        const reg = await navigator.serviceWorker.ready;
        const existing = await reg.pushManager.getSubscription();
        if (existing) {
          await fetch('/api/push/subscribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rid: RID, subscription: existing })
          });
          return;
        }

        const vapidPublicKey = window.VAPID_PUBLIC_KEY;
        if (!vapidPublicKey || typeof vapidPublicKey !== 'string') return;

        const padding = '='.repeat((4 - (vapidPublicKey.length % 4)) % 4);
        const base64 = (vapidPublicKey + padding).replace(/-/g, '+').replace(/_/g, '/');
        const raw = atob(base64);
        const key = new Uint8Array([...raw].map(ch => ch.charCodeAt(0)]);

        const subscription = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: key
        });

        await fetch('/api/push/subscribe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ rid: RID, subscription })
        });
      } catch (e) {}
    }

    async function enableNotifications() {
      try {
        if (!isStandaloneApp() || !notificationsSupported()) return;
        const perm = await Notification.requestPermission();
        updateNotifUI();
        if (perm === 'granted') {
          try {
            new Notification('BoniBuddy', { body: 'Obvestila so vkljuƒçena. Sporoƒçim, ko najdem match.' });
          } catch (e) {}
          await bestEffortSubscribePush();
        }
      } catch (e) {}
    }

    const enableBtn = document.getElementById('enableNotifBtn');
    if (enableBtn) {
      enableBtn.addEventListener('click', () => {
        try { gtag('event', 'enable_notifications'); } catch (e) {}
        enableNotifications();
      });
    }

    updateNotifUI();

    (async () => {
      try {
        if (isStandaloneApp() && notificationsSupported() && pushSupported() && Notification.permission === 'granted') {
          await bestEffortSubscribePush();
        }
      } catch (e) {}
    })();

    async function poll() {
      const res = await fetch(`/status/{{ rid }}`);
      const data = await res.json();

      if (data.status === "matched") {
        sendWaitingDuration('matched');
        const heading = document.getElementById("heading");
        if (heading) heading.textContent = "‚úÖ Na≈°li smo dru≈æbo!";
        try {
          if (isStandaloneApp() && 'Notification' in window && Notification.permission === 'granted') {
            new Notification('BoniBuddy', {
              body: 'Na≈°li smo dru≈æbo! Odpri app in po≈°lji sporoƒçilo na Instagram.'
            });
          }
        } catch (e) {}

        const handle = data.other_instagram;
        const msg = `Hej! BoniBuddy naju je povezal za bone ({{ location }}). Greva skupaj {% if time_bucket == "today" %}za veƒçerjo üçï{% else %}za kosilo üçù{% endif %}?`;
        const ig = handle ? `https://instagram.com/${encodeURIComponent(handle)}` : null;

        const statusEl = document.getElementById("status");
        statusEl.innerHTML =
          `<div style="margin: 14px 0 10px;" class="muted">Klikni spodaj in po≈°lji prvo sporoƒçilo.</div>` +
          (handle ? `<div style="margin-bottom:10px; font-weight:600;">@${handle}</div>` : "") +
          (ig ? `<a class="btn" href="${ig}" target="_blank" rel="noopener">Odpri Instagram profil</a>` : "") +
          `<button class="btn" type="button" id="copyMsgBtn" style="margin-top:10px; background:#ffffff; color: var(--accent); border:1px solid var(--accent);">Kopiraj sporoƒçilo</button>`;

        const copyBtn = document.getElementById("copyMsgBtn");
        if (copyBtn) {
          copyBtn.addEventListener("click", async () => {
            try {
              await navigator.clipboard.writeText(msg);
              copyBtn.textContent = "Skopirano ‚úì";
              setTimeout(() => { copyBtn.textContent = "Kopiraj sporoƒçilo"; }, 1800);
            } catch (e) {
              copyBtn.textContent = "Ni ≈°lo, kopiraj roƒçno";
            }
          });
        }

        // GA: open_instagram for polling-based match CTA
        const igLink = statusEl.querySelector('a.btn[target=\"_blank\"]');
        if (igLink && typeof window.gtag === 'function') {
          igLink.addEventListener('click', () => {
            gtag('event', 'open_instagram', {
              source: 'poll_match',
              restaurant_id: '{{ restaurant_id }}' || undefined,
            });
          }, { once: true });
        }
        return;
      }

      if (data.status === "expired") {
        const heading = document.getElementById("heading");
        if (heading) heading.textContent = "‚è±Ô∏è Request je potekel";
        document.getElementById("status").innerHTML =
          `<div class="error">Request je potekel. Poskusi ≈°e enkrat na zaƒçetni strani.</div>`;
        return;
      }

      setTimeout(poll, 3000);
    }

    poll();

        // GA: ensure open_instagram fires for polling-based match UI
        (function() {
          const restaurantId = '{{ restaurant_id }}';
      const originalStatus = document.getElementById('status');
      const origPoll = poll;

      // wrap poll success branch to insert tracking on injected button
      poll = async function wrappedPoll() {
        await origPoll.apply(this, arguments);
        // Attach handler if polling injected the CTA
        const igLink = originalStatus?.querySelector('a.btn[target="_blank"]');
        if (igLink && !igLink.dataset.gaBound) {
          igLink.dataset.gaBound = '1';
          igLink.addEventListener('click', () => {
            if (typeof window.gtag !== 'function') return;
            gtag('event', 'open_instagram', {
              source: 'poll_match',
              restaurant_id: restaurantId || undefined,
            });
          });
        }
      }
    })();
  </script>
  {% endif %}
  </body>
  </html>
